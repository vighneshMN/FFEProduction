angular.module("ps.inputTime",[]).value("psInputTimeConfig",{minuteStep:5,minDate:null,maxDate:null,fixedDay:!0,format:"hh:mma"}).directive("psInputTime",["$filter","psInputTimeConfig","$parse",function(e,t,n){var i=new RegExp("^((0[1-9])|(1[0-2]))(:)([0-5][0-9])[apAP][mM]$",["i"]),u=new RegExp("^((0?[0-9])|(1[0-2]))([0-5][0-9])[apAP][mM]$",["i"]),a=new RegExp("^([01]?[0-9]|2[0-3])[:;][0-5][0-9]$",["i"]),l=new RegExp("^(2[0-3]|[01]?[0-9])([0-5][0-9])$",["i"]),r=new RegExp("^(([])|(0[1-9]?)|(1[0-2]?))(:)([0-5][0-9]?)[apAP][mM]$",["i"]);return{restrict:"A",require:"?^ngModel",scope:{},link:function(o,s,m,c){if(c){c.$render=function(){s.val(x(c.$modelValue))};var d=V(m.minuteStep,t.minuteStep),f=V(m.fixedDay,t.fixedDay),p=m.format||t.format,$=null,h=null;(m.min||m.max)&&(f=!1),m.max&&o.$parent.$watch(n(m.max),function(e){$=e?new Date(e):null,g()}),m.min&&o.$parent.$watch(n(m.min),function(e){h=e?new Date(e):null,g()});var v=!1;s.on("keydown",function(e){switch(v=!1,e.keyCode){case 37:A(e);break;case 38:!function(){var e=M();"hour"==e?k(60):"minute"==e?k(d):"meridian"==e&&((c.$modelValue?c.$modelValue:y()).getHours>12?k(-720):k(720));b(e)}();break;case 39:D();break;case 40:!function(){var e=M();"hour"==e?k(-60):"minute"==e?k(-1):"meridian"==e&&((c.$modelValue?c.$modelValue:y()).getHours>12?k(720):k(-720));b(e)}();break;case 9:e.shiftKey?"hour"!=M()&&(v=!0,A(e)):"meridian"!=M()&&(v=!0,D())}setTimeout(function(){var t=!1;switch(e.keyCode){case 37:case 38:case 39:case 40:w()&&(t=!0,v=!0);break;case 9:w()&&(t=!0);break;default:var n=s.val();t=!(n.length>7)&&(7===n.length?!!i.test(n):!!r.test(n))}t?c.$setViewValue(N(s.val(),c.$modelValue)):s.val(x(c.$modelValue))},0),v&&e.preventDefault()}).on("blur",function(){setTimeout(function(){"invalid"==P(s.val())||v?s.val(x(c.$modelValue)):o.$apply(function(){c.$setViewValue(N(s.val(),c.$modelValue))})},0)}).on("click",function(){b(M())}),c.$parsers.push(function(e){if(e)return angular.isDate(e)?(g(),c.$setValidity("time",!0),null!==h&&e<h&&(e=new Date(h)),null!==$&&e>$&&(e=new Date($)),e):(c.$setValidity("time",!1),c.$modelValue)}),c.$formatters.push(x)}function V(e,t){return angular.isDefined(e)?o.$parent.$eval(e):t}function g(){null!==h&&c.$modelValue<h?c.$setValidity("time-min",!1):null!==h&&c.$setValidity("time-min",!0),null!==$&&c.$modelValue>$?c.$setValidity("time-max",!1):null!==$&&c.$setValidity("time-max",!0)}function w(){return"12hr"==P(s.val())||(""===s.val()?(s.val(x(y())),c.$setViewValue(y()),setTimeout(function(){b("hour")},0),!0):"invalid"!=P(s.val())&&(s.val(x(c.$modelValue)),c.$setViewValue(y()),setTimeout(function(){b("hour")},0),!0))}function b(e){"hour"==e?setTimeout(function(){s[0].setSelectionRange(0,2)},0):"minute"==e?setTimeout(function(){s[0].setSelectionRange(3,5)},0):setTimeout(function(){s[0].setSelectionRange(5,7)},0)}function M(){var e=s.prop("selectionStart");return s.val().length<1?"hour":e<3?"hour":e<5?"minute":e<8?"meridian":"unknown"}function D(){var e=M();b("hour"==e?"minute":"minute"==e?"meridian":"hour")}function A(e){var t=M();"meridian"==t?(b("minute"),e.preventDefault()):"minute"==t?(b("hour"),e.preventDefault()):b("meridian")}function y(){return null!==h?new Date(h):null!==$?new Date($):new Date}function x(t){if(t)return e("date")(t,p)}function N(e,t){isNaN(t)&&(t=y());var n,i,u,a,l=P(e);if("12hr"==l)i=Number(e.match(/^(\d+)/)[1]),n=Number(e.match(/:(\d+)/)[1]),AMPM=e.match(/[apAP][mM]/)[0],"PM"==AMPM.toUpperCase()&&i<12&&(i+=12),"AM"==AMPM.toUpperCase()&&12==i&&(i-=12);else if("24hr"==l)i=e.split(/[;:]/)[0],n=e.split(/[;:]/)[1];else if("24nc"==l)i=4==e.length?e.substr(0,2):e.substr(0,1),n=e.substr(-2);else{if("12nc"!=l)return"invalid";timeAsNumber=Number(e.match(/^(\d+)/)[1]).toString(),i=4==timeAsNumber.length?Number(timeAsNumber.substr(0,2)):Number(timeAsNumber.substr(0,1)),n=Number(timeAsNumber.substr(-2)),AMPM=e.match(/[apAP][mM]/)[0],"PM"==AMPM.toUpperCase()&&i<12&&(i+=12),"AM"==AMPM.toUpperCase()&&12==i&&(i-=12)}return u=i.toString(),a=n.toString(),console.log("sMinutes",a,"sHours",u),i<10&&(u="0"+u),n<10&&(a="0"+a),t.setHours(u,a),new Date(t)}function P(e){return i.test(e)?"12hr":a.test(e)?"24hr":l.test(e)?"24nc":u.test(e)?"12nc":"invalid"}function k(e){selected=c.$modelValue?new Date(c.$modelValue):y(),dt=new Date(selected.getTime()+6e4*e),!0!==f&&"true"!=f||(dt=selected.setHours(dt.getHours(),dt.getMinutes()),dt=new Date(dt)),o.$apply(function(){c.$setViewValue(dt)}),s.val(x(c.$modelValue))}}}}]);